version: "3.9"

# ─────────────────────────────────────────────────────────────────────────────
# APEX-KV 3-node reproducible example
#
#   docker compose up            # start cluster
#   docker compose exec node1 kv --client 127.0.0.1:7001   # interactive REPL
#   docker compose down -v       # destroy (wipes WAL volumes)
# ─────────────────────────────────────────────────────────────────────────────

x-node-common: &node-common
  image: apex-kv:latest
  build:
    context: .
    target: debug
  restart: unless-stopped
  networks:
    - apex

services:
  node1:
    <<: *node-common
    container_name: apex-node1
    hostname: node1
    command:
      - "--id=1"
      - "--port=7001"
      - "--wal-dir=/data"
      - "--peers=node2:7002:2,node3:7003:3"
    ports:
      - "7001:7001"
      - "8001:8001/udp"
    volumes:
      - node1-data:/data

  node2:
    <<: *node-common
    container_name: apex-node2
    hostname: node2
    command:
      - "--id=2"
      - "--port=7002"
      - "--wal-dir=/data"
      - "--peers=node1:7001:1,node3:7003:3"
    ports:
      - "7002:7002"
      - "8002:8002/udp"
    volumes:
      - node2-data:/data

  node3:
    <<: *node-common
    container_name: apex-node3
    hostname: node3
    command:
      - "--id=3"
      - "--port=7003"
      - "--wal-dir=/data"
      - "--peers=node1:7001:1,node2:7002:2"
    ports:
      - "7003:7003"
      - "8003:8003/udp"
    volumes:
      - node3-data:/data

  # Prometheus scrapes /metrics from all three nodes
  prometheus:
    image: prom/prometheus:latest
    container_name: apex-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./scripts/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - apex
    depends_on:
      - node1
      - node2
      - node3

volumes:
  node1-data:
  node2-data:
  node3-data:

networks:
  apex:
    driver: bridge
